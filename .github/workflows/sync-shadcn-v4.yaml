name: Sync shadcn/ui v4 for Monorepo with Tailwind CSS v4

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    - cron: "0 0 * * 1" # 매주 월요일 자정에 실행
  workflow_dispatch: # 수동 실행 가능
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' &&
       github.ref == 'refs/heads/main' &&
       (contains(github.event.head_commit.message, 'Merge pull request') &&
        contains(github.event.head_commit.message, 'sync/shadcn-v4')))

    steps:
      - name: Debug Event Information
        run: |
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Commit message: ${{ github.event.head_commit.message }}"

      - name: Checkout current repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create and prepare sync branch
        run: |
          git checkout -b sync/shadcn-v4-monorepo || git checkout sync/shadcn-v4-monorepo
          git reset --hard origin/main
          echo "현재 브랜치: $(git branch --show-current)"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq rsync

      - name: Clone shadcn/ui v4
        run: git clone --depth=1 https://github.com/shadcn-ui/ui.git tmp-shadcn-ui

      - name: Debug Directory Structure
        run: |
          echo "========== Repository Structure =========="
          ls -la
          echo "========== packages/ui Structure =========="
          ls -la packages/ui/src || echo "packages/ui/src directory does not exist yet"
          echo "========== shadcn v4 registry components =========="
          ls -la tmp-shadcn-ui/apps/v4/registry/new-york-v4/ui || echo "V4 registry components directory does not exist"

      - name: Create required directories
        run: |
          mkdir -p packages/ui/src/components
          mkdir -p packages/ui/src/lib
          mkdir -p packages/ui/src/hooks
          mkdir -p packages/ui/src/styles

      - name: Sync from v4 registry components
        run: |
          echo "Syncing components from v4 registry..."

          # V4 New York 레지스트리 컴포넌트 동기화
          if [ -d tmp-shadcn-ui/apps/v4/registry/new-york-v4/ui ]; then
            echo "=== V4 New York 레지스트리 컴포넌트 동기화 ==="
            rsync -av --exclude="*-demo.tsx" --exclude="*.stories.tsx" --exclude="*.test.tsx" \
              tmp-shadcn-ui/apps/v4/registry/new-york-v4/ui/ packages/ui/src/components/ | tee rsync-components.log

            # utils, lib 동기화
            if [ -d tmp-shadcn-ui/apps/v4/registry/new-york-v4/lib ]; then
              echo "=== V4 New York 레지스트리 lib 동기화 ==="
              rsync -av tmp-shadcn-ui/apps/v4/registry/new-york-v4/lib/ packages/ui/src/lib/ | tee rsync-lib.log
            fi

            # hooks 동기화
            if [ -d tmp-shadcn-ui/apps/v4/registry/new-york-v4/hooks ]; then
              echo "=== V4 New York 레지스트리 hooks 동기화 ==="
              rsync -av tmp-shadcn-ui/apps/v4/registry/new-york-v4/hooks/ packages/ui/src/hooks/ | tee rsync-hooks.log
            fi

            # styles 동기화
            if [ -d tmp-shadcn-ui/apps/v4/registry/new-york-v4/styles ]; then
              echo "=== V4 New York 레지스트리 styles 동기화 ==="
              rsync -av tmp-shadcn-ui/apps/v4/registry/new-york-v4/styles/ packages/ui/src/styles/ | tee rsync-styles.log
            fi

            # components.json 파일 동기화 (존재하는 경우)
            if [ -f tmp-shadcn-ui/apps/v4/registry/new-york-v4/components.json ]; then
              echo "=== V4 New York 레지스트리 components.json 동기화 ==="
              cp tmp-shadcn-ui/apps/v4/registry/new-york-v4/components.json packages/ui/
              # Tailwind CSS v4 호환성을 위해 tailwind.config 비움
              jq '.tailwind.config = ""' packages/ui/components.json > packages/ui/components.json.tmp
              mv packages/ui/components.json.tmp packages/ui/components.json
            fi

            # 변경사항이 있음을 표시
            touch .sync-changes-detected
          else
            echo "ERROR: V4 registry components directory not found at apps/v4/registry/new-york-v4/ui"
            exit 1
          fi

      - name: Clean up temporary files
        run: rm -rf tmp-shadcn-ui

      - name: Check for changes
        id: check_changes
        run: |
          echo "Checking for changes..."
          git_status=$(git status --porcelain)
          echo "Git status output: $git_status"

          # 변경사항 감지 파일 확인
          if [[ -f ".sync-changes-detected" ]] || [[ -n "$git_status" ]]; then
            echo "Changes detected, preparing commit..."

            # 변경사항이 없는 경우에도 커밋을 생성하기 위한 빈 파일 생성
            if [[ -z "$git_status" ]]; then
              echo "Git status is empty, creating a dummy change for testing"
              echo "Last sync: $(date)" > packages/ui/src/.sync-timestamp
            fi

            echo "changes=true" >> $GITHUB_OUTPUT
            git add .
            git commit -m "chore: sync shadcn/ui v4 components for monorepo"
            git push -f origin sync/shadcn-v4-monorepo
            echo "Changes pushed to sync/shadcn-v4-monorepo branch"
          else
            echo "No changes detected."
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ github.token }}
          commit-message: "chore: sync shadcn/ui v4 components for monorepo"
          title: "chore: sync shadcn/ui v4 components for monorepo"
          body: |
            # shadcn/ui v4 컴포넌트 동기화

            이 PR은 shadcn/ui v4의 monorepo 템플릿에서 컴포넌트, 유틸리티, 훅, 스타일을 동기화합니다.

            ## 동기화된 항목
            - 컴포넌트 (`/src/components/`)
            - 유틸리티 (`/src/lib/`)
            - 훅 (`/src/hooks/`)
            - 스타일 (`/src/styles/`)
            - 의존성 (`package.json`)
            - 설정 (`components.json`)

            ## Tailwind CSS v4 호환성

            이 PR은 Tailwind CSS v4와 호환되도록 업데이트되었습니다.

            변경사항을 검토하고 필요한 경우 수정 후 머지해주세요.
          branch: "sync/shadcn-v4-monorepo"
          base: "main"
          labels: "dependencies,ui,shadcn"

      - name: PR Result
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          echo "Pull Request 생성됨: sync/shadcn-v4-monorepo → main"
